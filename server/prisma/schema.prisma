generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Ticker {
  symbol   String  @id
  name     String?
  sector   String?
  industry String?

  bars     PriceBarDaily[]
  groups   GroupMember[]
  results  AnalysisResult[]
  fundamentals FundamentalQuarter[]
}

model Group {
  id      String @id @default(cuid())
  name    String
  type    String  // "manual" | "sector" | "cluster"
  members GroupMember[]
}

model GroupMember {
  groupId String
  symbol  String

  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  ticker  Ticker @relation(fields: [symbol], references: [symbol], onDelete: Cascade)

  @@id([groupId, symbol])
  @@index([symbol])
}

model PriceBarDaily {
  symbol String
  date   DateTime
  open   Float
  high   Float
  low    Float
  close  Float
  volume Float?

  ticker Ticker @relation(fields: [symbol], references: [symbol], onDelete: Cascade)

  @@id([symbol, date])
  @@index([date])
}

model AnalysisRun {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  scope        String?  // e.g. "group:<id>" or "symbols:AAPL,MSFT"
  providerUsed String?
  parametersJson String? // JSON as string

  results      AnalysisResult[]
}

model AnalysisResult {
  id        String   @id @default(cuid())
  runId     String
  symbol    String

  metricsJson String?  // JSON as string
  signalsJson String?  // JSON as string

  run       AnalysisRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  ticker    Ticker      @relation(fields: [symbol], references: [symbol], onDelete: Cascade)

  @@index([runId])
  @@index([symbol])
  @@unique([runId, symbol])
}

model FundamentalQuarter {
  symbol             String
  periodEnd          DateTime
  fiscalYear         Int?
  fiscalQuarter      Int?
  currency           String?

  revenue            Float?
  grossProfit        Float?
  operatingIncome    Float?
  netIncome          Float?
  epsBasic           Float?
  epsDiluted         Float?

  totalAssets        Float?
  totalLiabilities   Float?
  cashAndEquivalents Float?
  totalDebt          Float?
  sharesOutstanding  Float?

  epsTtm             Float?
  priceAsOf          DateTime?
  priceClose         Float?
  peTtm              Float?

  source             String
  fetchedAt          DateTime @default(now())

  ticker             Ticker @relation(fields: [symbol], references: [symbol], onDelete: Cascade)

  @@id([symbol, periodEnd])
  @@index([periodEnd])
}

model FundamentalSyncState {
  id        String   @id @default("global")
  status    String?
  lastRunAt DateTime?
  lastError String?
  updatedAt DateTime @updatedAt
}
